# =============================================================================
# ExternalSecret - Fetches PicoClaw agent secrets from Azure Key Vault (DEV)
# Assembles config.json and oluto-config.json from individual Key Vault secrets
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: picoclaw-secrets
  namespace: oluto
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-keyvault
  target:
    name: picoclaw-config
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        # PicoClaw runtime config — assembled from Key Vault secrets
        config.json: |
          {
            "session": {
              "dm_scope": "main"
            },
            "agents": {
              "defaults": {
                "workspace": "~/.picoclaw/workspace",
                "restrict_to_workspace": true,
                "provider": "",
                "model": "fuelix-{{ .picoclaw_fuelix_model }}",
                "max_tokens": 16384,
                "max_tool_iterations": 25
              }
            },
            "channels": {
              "telegram": {
                "enabled": true,
                "token": "{{ .picoclaw_telegram_token }}",
                "proxy": "",
                "allow_from": []
              }
            },
            "model_list": [
              {
                "model_name": "fuelix-{{ .picoclaw_fuelix_model }}",
                "model": "{{ .picoclaw_fuelix_model }}",
                "api_base": "{{ .picoclaw_fuelix_base_url }}",
                "api_key": "{{ .picoclaw_fuelix_api_key }}"
              }
            ],
            "gateway": {
              "host": "0.0.0.0",
              "port": 18790,
              "require_pairing": false,
              "paired_tokens": []
            },
            "tools": {
              "web": {
                "duckduckgo": {
                  "enabled": true,
                  "max_results": 5
                }
              },
              "cron": {
                "exec_timeout_minutes": 5
              },
              "exec": {
                "enable_deny_patterns": true,
                "custom_deny_patterns": null
              }
            },
            "heartbeat": {
              "enabled": true,
              "interval": 30
            },
            "devices": {
              "enabled": false
            }
          }

        # Oluto agent config — LedgerForge API credentials
        oluto-config.json: |
          {
            "base_url": "http://oluto-backend.oluto.svc.cluster.local",
            "email": "{{ .picoclaw_oluto_email }}",
            "password": "{{ .picoclaw_oluto_password }}",
            "default_business_id": "{{ .picoclaw_oluto_business_id }}"
          }

  data:
    - secretKey: picoclaw_telegram_token
      remoteRef:
        key: picoclaw-telegram-token

    - secretKey: picoclaw_fuelix_api_key
      remoteRef:
        key: picoclaw-fuelix-api-key

    - secretKey: picoclaw_fuelix_base_url
      remoteRef:
        key: picoclaw-fuelix-base-url

    - secretKey: picoclaw_fuelix_model
      remoteRef:
        key: picoclaw-fuelix-model

    - secretKey: picoclaw_oluto_email
      remoteRef:
        key: picoclaw-oluto-email

    - secretKey: picoclaw_oluto_password
      remoteRef:
        key: picoclaw-oluto-password

    - secretKey: picoclaw_oluto_business_id
      remoteRef:
        key: picoclaw-oluto-business-id
