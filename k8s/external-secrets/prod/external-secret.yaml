# =============================================================================
# ExternalSecret - Fetches Oluto secrets from Azure Key Vault (PROD)
# Syncs secrets from Key Vault to Kubernetes native secret
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: oluto-secrets
  namespace: oluto
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-keyvault
  target:
    name: oluto-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        # PostgreSQL (set by Terraform)
        POSTGRES_SERVER: "{{ .oluto_postgres_host }}"
        POSTGRES_PORT: "{{ .oluto_postgres_port }}"
        POSTGRES_USER: "{{ .oluto_postgres_user }}"
        POSTGRES_PASSWORD: "{{ .postgres_password }}"
        POSTGRES_DB: "{{ .oluto_postgres_db }}"

        # Application (set by 03-secrets-setup pipeline)
        SECRET_KEY: "{{ .oluto_secret_key }}"

        # Celery / Redis (set by 03-secrets-setup pipeline)
        CELERY_BROKER_URL: "{{ .oluto_celery_broker_url }}"
        CELERY_RESULT_BACKEND: "{{ .oluto_celery_result_backend }}"

        # Fuelix AI (set by 03-secrets-setup pipeline)
        FUELIX_API_KEY: "{{ .oluto_fuelix_api_key }}"
        FUELIX_BASE_URL: "{{ .oluto_fuelix_base_url }}"
        FUELIX_MODEL: "{{ .oluto_fuelix_model }}"

        # Azure OCR (set by 03-secrets-setup pipeline)
        AZURE_API_KEY: "{{ .oluto_azure_api_key }}"
        AZURE_OCR_URL: "{{ .oluto_azure_ocr_url }}"
        AZURE_OCR_MODEL: "{{ .oluto_azure_ocr_model }}"

  data:
    # PostgreSQL secrets (created by Terraform)
    - secretKey: oluto_postgres_host
      remoteRef:
        key: oluto-postgres-host

    - secretKey: oluto_postgres_port
      remoteRef:
        key: oluto-postgres-port

    - secretKey: oluto_postgres_user
      remoteRef:
        key: oluto-postgres-user

    - secretKey: postgres_password
      remoteRef:
        key: postgres-password

    - secretKey: oluto_postgres_db
      remoteRef:
        key: oluto-postgres-db

    # Application secrets (set by 03-secrets-setup pipeline)
    - secretKey: oluto_secret_key
      remoteRef:
        key: oluto-secret-key

    # Celery / Redis
    - secretKey: oluto_celery_broker_url
      remoteRef:
        key: oluto-celery-broker-url

    - secretKey: oluto_celery_result_backend
      remoteRef:
        key: oluto-celery-result-backend

    # Fuelix AI
    - secretKey: oluto_fuelix_api_key
      remoteRef:
        key: oluto-fuelix-api-key

    - secretKey: oluto_fuelix_base_url
      remoteRef:
        key: oluto-fuelix-base-url

    - secretKey: oluto_fuelix_model
      remoteRef:
        key: oluto-fuelix-model

    # Azure OCR
    - secretKey: oluto_azure_api_key
      remoteRef:
        key: oluto-azure-api-key

    - secretKey: oluto_azure_ocr_url
      remoteRef:
        key: oluto-azure-ocr-url

    - secretKey: oluto_azure_ocr_model
      remoteRef:
        key: oluto-azure-ocr-model
