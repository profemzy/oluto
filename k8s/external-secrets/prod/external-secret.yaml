# =============================================================================
# ExternalSecret - Fetches Oluto secrets from Azure Key Vault (PROD)
# Syncs secrets from Key Vault to Kubernetes native secret
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: oluto-secrets
  namespace: oluto
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-keyvault
  target:
    name: oluto-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        # LedgerForge backend (Rust/Axum)
        DATABASE_URL: "{{ .oluto_database_url }}"
        JWT_SECRET: "{{ .oluto_jwt_secret }}"

        # AI Categorization
        FUELIX_API_KEY: "{{ .oluto_fuelix_api_key }}"
        FUELIX_BASE_URL: "{{ .oluto_fuelix_base_url }}"
        FUELIX_MODEL: "{{ .oluto_fuelix_model }}"

        # Azure OCR (PDF import)
        AZURE_API_KEY: "{{ .oluto_azure_api_key }}"
        AZURE_OCR_URL: "{{ .oluto_azure_ocr_url }}"
        AZURE_OCR_MODEL: "{{ .oluto_azure_ocr_model }}"

  data:
    - secretKey: oluto_database_url
      remoteRef:
        key: oluto-database-url

    - secretKey: oluto_jwt_secret
      remoteRef:
        key: oluto-jwt-secret

    - secretKey: oluto_fuelix_api_key
      remoteRef:
        key: oluto-fuelix-api-key

    - secretKey: oluto_fuelix_base_url
      remoteRef:
        key: oluto-fuelix-base-url

    - secretKey: oluto_fuelix_model
      remoteRef:
        key: oluto-fuelix-model

    - secretKey: oluto_azure_api_key
      remoteRef:
        key: oluto-azure-api-key

    - secretKey: oluto_azure_ocr_url
      remoteRef:
        key: oluto-azure-ocr-url

    - secretKey: oluto_azure_ocr_model
      remoteRef:
        key: oluto-azure-ocr-model
