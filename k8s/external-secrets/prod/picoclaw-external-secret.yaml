# =============================================================================
# ExternalSecret - Fetches PicoClaw agent secrets from Azure Key Vault (PROD)
# Assembles config.json and oluto-config.json from individual Key Vault secrets
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: picoclaw-secrets
  namespace: oluto
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-keyvault
  target:
    name: picoclaw-config
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        # PicoClaw runtime config — assembled from Key Vault secrets
        config.json: |
          {
            "session": {
              "dm_scope": "main"
            },
            "agents": {
              "defaults": {
                "workspace": "~/.picoclaw/workspace",
                "restrict_to_workspace": true,
                "provider": "",
                "model": "fuelix-{{ .picoclaw_fuelix_model }}",
                "max_tokens": 16384,
                "max_tool_iterations": 25
              }
            },
            "channels": {},
            "model_list": [
              {
                "model_name": "fuelix-{{ .picoclaw_fuelix_model }}",
                "model": "{{ .picoclaw_fuelix_model }}",
                "api_base": "{{ .picoclaw_fuelix_base_url }}",
                "api_key": "{{ .picoclaw_fuelix_api_key }}"
              }
            ],
            "gateway": {
              "host": "0.0.0.0",
              "port": 18790,
              "require_pairing": false,
              "paired_tokens": [],
              "jwt_secret": "{{ .picoclaw_jwt_secret }}"
            },
            "tools": {
              "web": {
                "duckduckgo": {
                  "enabled": true,
                  "max_results": 5
                }
              },
              "cron": {
                "exec_timeout_minutes": 5
              },
              "exec": {
                "enable_deny_patterns": true,
                "custom_deny_patterns": null
              }
            },
            "heartbeat": {
              "enabled": true,
              "interval": 30
            },
            "devices": {
              "enabled": false
            }
          }

        # Oluto agent config — LedgerForge connection + service account credentials
        # JWT passthrough is used for user-initiated requests (mobile/desktop);
        # email/password is used for autonomous operations (daily briefing, cron)
        oluto-config.json: |
          {
            "base_url": "http://oluto-backend.oluto.svc.cluster.local",
            "email": "{{ .oluto_agent_email }}",
            "password": "{{ .oluto_agent_password }}"
          }

  data:
    - secretKey: picoclaw_fuelix_api_key
      remoteRef:
        key: oluto-fuelix-api-key

    - secretKey: picoclaw_fuelix_base_url
      remoteRef:
        key: oluto-fuelix-base-url

    - secretKey: picoclaw_fuelix_model
      remoteRef:
        key: picoclaw-fuelix-model

    - secretKey: picoclaw_jwt_secret
      remoteRef:
        key: oluto-jwt-secret

    - secretKey: oluto_agent_email
      remoteRef:
        key: oluto-agent-email

    - secretKey: oluto_agent_password
      remoteRef:
        key: oluto-agent-password

