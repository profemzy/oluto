# =============================================================================
# Pipeline: 01-app-ci.yml
# Purpose: Build and push Oluto frontend Docker image to ACR
# Triggers: Changes to frontend code on master/main
#
# Note: Backend (LedgerForge) has its own CI pipeline in the ledger-forge repo.
# =============================================================================

trigger:
  branches:
    include:
      - master
      - main
  paths:
    include:
      - apps/**
      - packages/**
      - package.json

pr:
  branches:
    include:
      - master
      - main

variables:
  acrLoginServer: "wackopscoachdevacr.azurecr.io"
  azureServiceConnection: "terraformiacdevops1"
  frontendImageRepository: "oluto-frontend"
  tag: "$(Build.BuildId)"
  latestTag: "latest"

stages:
  - stage: Build
    displayName: "Build & Push Frontend"
    jobs:
      - job: Build_Frontend
        displayName: "Build & Push Frontend Image"
        pool:
          vmImage: "ubuntu-24.04"
        steps:
          - checkout: self
            displayName: "Checkout Source Code"

          - task: AzureCLI@2
            displayName: "Login to ACR"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "Logging into ACR: $(acrLoginServer)"
                az acr login --name $(acrLoginServer)

          - task: Docker@2
            displayName: "Build Frontend Image"
            inputs:
              command: "build"
              repository: "$(acrLoginServer)/$(frontendImageRepository)"
              Dockerfile: "$(Build.SourcesDirectory)/apps/web/Dockerfile"
              buildContext: "$(Build.SourcesDirectory)"
              tags: |
                $(tag)
                $(latestTag)
              arguments: "--build-arg NEXT_PUBLIC_API_URL=/api/v1"

          - task: Docker@2
            displayName: "Push Frontend Image"
            inputs:
              command: "push"
              repository: "$(acrLoginServer)/$(frontendImageRepository)"
              tags: |
                $(tag)
                $(latestTag)

      - job: Publish_Build_Info
        displayName: "Publish Build Info"
        dependsOn: Build_Frontend
        pool:
          vmImage: "ubuntu-24.04"
        steps:
          - task: Bash@3
            displayName: "Export Build Info"
            inputs:
              targetType: "inline"
              script: |
                echo "Image Tag: $(tag)"
                echo "Frontend: $(acrLoginServer)/$(frontendImageRepository):$(tag)"
                echo "$(tag)" > $(Build.ArtifactStagingDirectory)/image-tag.txt

          - task: PublishBuildArtifacts@1
            displayName: "Publish Build Info"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "build-info"
              publishLocation: "Container"
