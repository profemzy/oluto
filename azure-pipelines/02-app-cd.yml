# =============================================================================
# Pipeline: 02-app-cd.yml
# Purpose: Deploy Oluto application to AKS clusters (DEV â†’ PROD)
# Triggers: Successful CI builds or manual runs
# =============================================================================

trigger: none

name: "Oluto Application CD"

resources:
  pipelines:
    - pipeline: app-ci
      source: "01-App-CI"
      trigger:
        enabled: true
        branches:
          include:
            - master
            - main

variables:
  # Container Registry
  acrLoginServer: "wackopscoachdevacr.azurecr.io"
  acrLoginServerProd: "wackopscoachprodacr.azurecr.io"

  # Kubernetes
  aksServiceConnection: "terraformiacdevops1"

  # Image Configuration
  backendImageRepository: "oluto-backend"
  frontendImageRepository: "oluto-frontend"

# Parameters for manual runs
parameters:
  - name: imageTag
    displayName: "Image Tag to Deploy"
    type: string
    default: "latest"
  - name: deployDev
    displayName: "Deploy to DEV"
    type: boolean
    default: true
  - name: deployProd
    displayName: "Deploy to PROD"
    type: boolean
    default: true

stages:
  # ==========================================================================
  # Stage 1: Deploy to DEV
  # ==========================================================================
  - stage: Deploy_DEV
    displayName: "Deploy to DEV"
    condition: ${{ parameters.deployDev }}
    variables:
      imageTag: ${{ coalesce(variables['resources.pipeline.app-ci.runName'], parameters.imageTag) }}
    jobs:
      - deployment: Deploy_AKS_DEV
        displayName: "Deploy to DEV AKS"
        pool:
          vmImage: "ubuntu-24.04"
        environment: "dev"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                # Download build info from CI
                - task: DownloadBuildArtifacts@1
                  displayName: "Download Build Info"
                  inputs:
                    buildType: "specific"
                    project: "$(System.TeamProject)"
                    pipeline: "01-App-CI"
                    buildVersionToDownload: "latestFromBranch"
                    branchName: "$(Build.SourceBranch)"
                    downloadType: "single"
                    artifactName: "build-info"
                    downloadPath: "$(System.ArtifactsDirectory)"
                  continueOnError: true

                # Set image tag
                - task: Bash@3
                  displayName: "Set Image Tag"
                  inputs:
                    targetType: "inline"
                    script: |
                      if [ -f "$(System.ArtifactsDirectory)/build-info/image-tag.txt" ]; then
                        TAG=$(cat $(System.ArtifactsDirectory)/build-info/image-tag.txt)
                        echo "Using tag from CI: $TAG"
                        echo "##vso[task.setvariable variable=tag]$TAG"
                      else
                        echo "Using parameter tag: ${{ parameters.imageTag }}"
                        echo "##vso[task.setvariable variable=tag]${{ parameters.imageTag }}"
                      fi

                - task: AzureCLI@2
                  displayName: "Install kubectl and kubelogin"
                  inputs:
                    azureSubscription: $(aksServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      az aks install-cli
                      echo "##vso[task.prependpath]/usr/local/bin"

                - task: KubernetesManifest@1
                  displayName: "Create Namespace (DEV)"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "default"
                    manifests: |
                      k8s/dev/namespace.yaml

                - task: KubernetesManifest@1
                  displayName: "Create ExternalSecret (DEV)"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    manifests: |
                      k8s/external-secrets/dev/external-secret.yaml

                # Wait for secrets to sync
                - task: Kubernetes@1
                  displayName: "Wait for Secrets Sync"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    command: "wait"
                    arguments: "--for=condition=ready externalsecret/oluto-secrets --timeout=120s"
                  continueOnError: true

                # Update DEV manifests with image tag
                - task: Bash@3
                  displayName: "Update DEV Manifests"
                  inputs:
                    targetType: "inline"
                    script: |
                      echo "Deploying backend: $(acrLoginServer)/$(backendImageRepository):$(tag)"
                      echo "Deploying frontend: $(acrLoginServer)/$(frontendImageRepository):$(tag)"
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServer)/$(backendImageRepository):$(tag)|g" k8s/dev/backend-deployment.yaml
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServer)/$(backendImageRepository):$(tag)|g" k8s/dev/worker-deployment.yaml
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServer)/$(backendImageRepository):$(tag)|g" k8s/dev/flower-deployment.yaml
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServer)/$(backendImageRepository):$(tag)|g" k8s/dev/migration-job.yaml
                      sed -i "s|image:.*oluto-frontend:.*|image: $(acrLoginServer)/$(frontendImageRepository):$(tag)|g" k8s/dev/frontend-deployment.yaml
                      echo "--- Backend deployment image:"
                      grep "image:" k8s/dev/backend-deployment.yaml
                      echo "--- Frontend deployment image:"
                      grep "image:" k8s/dev/frontend-deployment.yaml

                # Delete old migration job (Jobs are immutable)
                - task: Kubernetes@1
                  displayName: "Delete Old Migration Job (DEV)"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    command: "delete"
                    arguments: "job/oluto-migration --ignore-not-found"
                  continueOnError: true

                # Deploy to DEV AKS
                - task: KubernetesManifest@1
                  displayName: "Deploy to DEV AKS"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    manifests: |
                      k8s/dev/namespace.yaml
                      k8s/dev/redis.yaml
                      k8s/dev/migration-job.yaml
                      k8s/dev/backend-deployment.yaml
                      k8s/dev/worker-deployment.yaml
                      k8s/dev/flower-deployment.yaml
                      k8s/dev/frontend-deployment.yaml
                      k8s/dev/services.yaml
                      k8s/dev/ingress.yaml

                - task: Kubernetes@1
                  displayName: "Wait for Migration"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    command: "wait"
                    arguments: "--for=condition=complete --timeout=300s job/oluto-migration"
                  continueOnError: true

                - task: Kubernetes@1
                  displayName: "Rollout Status - Backend"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    command: "rollout"
                    arguments: "status deployment/oluto-backend --timeout=300s"

                - task: Kubernetes@1
                  displayName: "Rollout Status - Frontend"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-dev-rg"
                    kubernetesCluster: "wackopscoach-dev-aks"
                    namespace: "oluto"
                    command: "rollout"
                    arguments: "status deployment/oluto-frontend --timeout=300s"

                - task: Bash@3
                  displayName: "Verify DEV"
                  inputs:
                    targetType: "inline"
                    script: |
                      echo "Verifying DEV at https://dev.oluto.app"
                      sleep 10
                      curl -sf https://dev.oluto.app/up || exit 1
                      echo "DEV deployment verified!"

  # ==========================================================================
  # Stage 2: Deploy to PROD (Requires Approval)
  # ==========================================================================
  - stage: Deploy_PROD
    displayName: "Deploy to PROD"
    dependsOn: Deploy_DEV
    condition: and(succeeded(), ${{ parameters.deployProd }})
    variables:
      imageTag: ${{ coalesce(variables['resources.pipeline.app-ci.runName'], parameters.imageTag) }}
    jobs:
      - deployment: Deploy_AKS_PROD
        displayName: "Deploy to PROD AKS"
        pool:
          vmImage: "ubuntu-24.04"
        environment: "prod"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                # Download build info from CI
                - task: DownloadBuildArtifacts@1
                  displayName: "Download Build Info"
                  inputs:
                    buildType: "specific"
                    project: "$(System.TeamProject)"
                    pipeline: "01-App-CI"
                    buildVersionToDownload: "latestFromBranch"
                    branchName: "$(Build.SourceBranch)"
                    downloadType: "single"
                    artifactName: "build-info"
                    downloadPath: "$(System.ArtifactsDirectory)"
                  continueOnError: true

                # Set image tag
                - task: Bash@3
                  displayName: "Set Image Tag"
                  inputs:
                    targetType: "inline"
                    script: |
                      if [ -f "$(System.ArtifactsDirectory)/build-info/image-tag.txt" ]; then
                        TAG=$(cat $(System.ArtifactsDirectory)/build-info/image-tag.txt)
                        echo "Using tag from CI: $TAG"
                        echo "##vso[task.setvariable variable=tag]$TAG"
                      else
                        echo "Using parameter tag: ${{ parameters.imageTag }}"
                        echo "##vso[task.setvariable variable=tag]${{ parameters.imageTag }}"
                      fi

                - task: AzureCLI@2
                  displayName: "Install kubectl and kubelogin"
                  inputs:
                    azureSubscription: $(aksServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      az aks install-cli
                      echo "##vso[task.prependpath]/usr/local/bin"

                # Promote images from DEV ACR to PROD ACR
                - task: AzureCLI@2
                  displayName: "Promote Images to PROD ACR"
                  inputs:
                    azureSubscription: $(aksServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      echo "Promoting images from $(acrLoginServer) to $(acrLoginServerProd)"
                      echo "Tag: $(tag)"
                      az acr import \
                        --name wackopscoachprodacr \
                        --source $(acrLoginServer)/$(backendImageRepository):$(tag) \
                        --image $(backendImageRepository):$(tag) \
                        --force
                      az acr import \
                        --name wackopscoachprodacr \
                        --source $(acrLoginServer)/$(frontendImageRepository):$(tag) \
                        --image $(frontendImageRepository):$(tag) \
                        --force
                      echo "Images promoted to PROD ACR"

                - task: KubernetesManifest@1
                  displayName: "Create Namespace (PROD)"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "default"
                    manifests: |
                      k8s/prod/namespace.yaml

                - task: KubernetesManifest@1
                  displayName: "Create ExternalSecret (PROD)"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    manifests: |
                      k8s/external-secrets/prod/external-secret.yaml

                # Wait for secrets to sync
                - task: Kubernetes@1
                  displayName: "Wait for Secrets Sync"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    command: "wait"
                    arguments: "--for=condition=ready externalsecret/oluto-secrets --timeout=120s"
                  continueOnError: true

                # Update PROD manifests with image tag
                - task: Bash@3
                  displayName: "Update PROD Manifests"
                  inputs:
                    targetType: "inline"
                    script: |
                      echo "Deploying backend: $(acrLoginServerProd)/$(backendImageRepository):$(tag)"
                      echo "Deploying frontend: $(acrLoginServerProd)/$(frontendImageRepository):$(tag)"
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServerProd)/$(backendImageRepository):$(tag)|g" k8s/prod/backend-deployment.yaml
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServerProd)/$(backendImageRepository):$(tag)|g" k8s/prod/worker-deployment.yaml
                      sed -i "s|image:.*oluto-backend:.*|image: $(acrLoginServerProd)/$(backendImageRepository):$(tag)|g" k8s/prod/migration-job.yaml
                      sed -i "s|image:.*oluto-frontend:.*|image: $(acrLoginServerProd)/$(frontendImageRepository):$(tag)|g" k8s/prod/frontend-deployment.yaml
                      echo "--- Backend deployment image:"
                      grep "image:" k8s/prod/backend-deployment.yaml
                      echo "--- Frontend deployment image:"
                      grep "image:" k8s/prod/frontend-deployment.yaml

                # Delete old migration job (Jobs are immutable)
                - task: Kubernetes@1
                  displayName: "Delete Old Migration Job (PROD)"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    command: "delete"
                    arguments: "job/oluto-migration --ignore-not-found"
                  continueOnError: true

                # Deploy to PROD AKS
                - task: KubernetesManifest@1
                  displayName: "Deploy to PROD AKS"
                  inputs:
                    action: "deploy"
                    connectionType: "azureResourceManager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    manifests: |
                      k8s/prod/namespace.yaml
                      k8s/prod/redis.yaml
                      k8s/prod/migration-job.yaml
                      k8s/prod/backend-deployment.yaml
                      k8s/prod/worker-deployment.yaml
                      k8s/prod/frontend-deployment.yaml
                      k8s/prod/services.yaml
                      k8s/prod/ingress.yaml

                - task: Kubernetes@1
                  displayName: "Wait for Migration"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    command: "wait"
                    arguments: "--for=condition=complete --timeout=300s job/oluto-migration"
                  continueOnError: true

                - task: Kubernetes@1
                  displayName: "Rollout Status - Backend"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    command: "rollout"
                    arguments: "status deployment/oluto-backend --timeout=300s"

                - task: Kubernetes@1
                  displayName: "Rollout Status - Frontend"
                  inputs:
                    connectionType: "Azure Resource Manager"
                    azureSubscriptionEndpoint: $(aksServiceConnection)
                    azureResourceGroup: "wackopscoach-prod-rg"
                    kubernetesCluster: "wackopscoach-prod-aks"
                    namespace: "oluto"
                    command: "rollout"
                    arguments: "status deployment/oluto-frontend --timeout=300s"

                - task: Bash@3
                  displayName: "Verify PROD"
                  inputs:
                    targetType: "inline"
                    script: |
                      echo "Verifying PROD at https://oluto.app"
                      sleep 10
                      curl -sf https://oluto.app/up || exit 1
                      echo "PROD deployment verified!"
