# =============================================================================
# Pipeline: 03-secrets-setup.yml
# Purpose: One-time setup of application secrets in Azure Key Vault
# Triggers: Manual only
#
# Usage: Run this pipeline once per environment to populate Key Vault with
# all application secrets. Terraform handles the DB server infrastructure;
# this pipeline handles application-level secrets for LedgerForge (DATABASE_URL,
# JWT, AI, OCR) and PicoClaw agent (Telegram token, LLM provider, agent creds).
# =============================================================================

trigger: none

name: "Oluto Secrets Setup"

parameters:
  - name: environment
    displayName: "Target Environment"
    type: string
    default: "dev"
    values:
      - dev
      - prod

  - name: databaseUrl
    displayName: "Database URL (postgresql://user:pass@host:port/db?sslmode=require)"
    type: string

  - name: jwtSecret
    displayName: "JWT Secret (signing key)"
    type: string

  - name: fuelixApiKey
    displayName: "Fuelix API Key"
    type: string

  - name: fuelixBaseUrl
    displayName: "Fuelix Base URL"
    type: string
    default: "https://api.fuelix.ai/v1"

  - name: fuelixModel
    displayName: "Fuelix Model"
    type: string
    default: "claude-haiku-4-5"

  - name: azureApiKey
    displayName: "Azure OCR API Key"
    type: string

  - name: azureOcrUrl
    displayName: "Azure OCR URL"
    type: string
    default: "https://profemzy-5149-resource.services.ai.azure.com/providers/mistral/azure/ocr"

  - name: azureOcrModel
    displayName: "Azure OCR Model"
    type: string
    default: "mistral-document-ai-2505"

  # --- PicoClaw Agent Secrets ---
  - name: picoclawTelegramToken
    displayName: "PicoClaw — Telegram Bot Token"
    type: string

  - name: picoclawFuelixApiKey
    displayName: "PicoClaw — Fuelix API Key (LLM provider)"
    type: string

  - name: picoclawFuelixBaseUrl
    displayName: "PicoClaw — Fuelix Base URL"
    type: string
    default: "https://api.fuelix.ai/v1"

  - name: picoclawFuelixModel
    displayName: "PicoClaw — Fuelix Model Name"
    type: string
    default: "gemini-3-flash"

  - name: picoclawOlutoEmail
    displayName: "PicoClaw — Oluto Agent Email/Username"
    type: string
    default: "oluto-agent"

  - name: picoclawOlutoPassword
    displayName: "PicoClaw — Oluto Agent Password (LedgerForge)"
    type: string

  - name: picoclawOlutoBusinessId
    displayName: "PicoClaw — Oluto Default Business ID"
    type: string
    default: "f0248a73-9cdb-408e-a22a-855d21d72373"

variables:
  azureServiceConnection: "terraformiacdevops1"

stages:
  - stage: Setup_Secrets
    displayName: "Setup Secrets (${{ parameters.environment }})"
    jobs:
      - job: Populate_KeyVault
        displayName: "Populate Key Vault Secrets"
        pool:
          vmImage: "ubuntu-24.04"
        steps:
          - task: AzureCLI@2
            displayName: "Set Oluto Secrets in Key Vault"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Setting secrets in Key Vault: $KV_NAME"

                # LedgerForge backend — DATABASE_URL + JWT_SECRET
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-database-url" \
                  --value "${{ parameters.databaseUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-jwt-secret" \
                  --value "${{ parameters.jwtSecret }}" \
                  --output none

                # Fuelix AI
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-api-key" \
                  --value "${{ parameters.fuelixApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-base-url" \
                  --value "${{ parameters.fuelixBaseUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-model" \
                  --value "${{ parameters.fuelixModel }}" \
                  --output none

                # Azure OCR (PDF import)
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-api-key" \
                  --value "${{ parameters.azureApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-ocr-url" \
                  --value "${{ parameters.azureOcrUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-ocr-model" \
                  --value "${{ parameters.azureOcrModel }}" \
                  --output none

                echo "LedgerForge secrets set."

                # PicoClaw Agent — Telegram + LLM + Oluto credentials
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-telegram-token" \
                  --value "${{ parameters.picoclawTelegramToken }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-api-key" \
                  --value "${{ parameters.picoclawFuelixApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-base-url" \
                  --value "${{ parameters.picoclawFuelixBaseUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-fuelix-model" \
                  --value "${{ parameters.picoclawFuelixModel }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-email" \
                  --value "${{ parameters.picoclawOlutoEmail }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-password" \
                  --value "${{ parameters.picoclawOlutoPassword }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "picoclaw-oluto-business-id" \
                  --value "${{ parameters.picoclawOlutoBusinessId }}" \
                  --output none

                echo "All secrets set successfully in $KV_NAME"

          - task: AzureCLI@2
            displayName: "Verify Secrets"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Verifying secrets in $KV_NAME..."

                SECRETS=(
                  "oluto-database-url"
                  "oluto-jwt-secret"
                  "oluto-fuelix-api-key"
                  "oluto-fuelix-base-url"
                  "oluto-fuelix-model"
                  "oluto-azure-api-key"
                  "oluto-azure-ocr-url"
                  "oluto-azure-ocr-model"
                  "picoclaw-telegram-token"
                  "picoclaw-fuelix-api-key"
                  "picoclaw-fuelix-base-url"
                  "picoclaw-fuelix-model"
                  "picoclaw-oluto-email"
                  "picoclaw-oluto-password"
                  "picoclaw-oluto-business-id"
                )

                for SECRET in "${SECRETS[@]}"; do
                  if az keyvault secret show --vault-name "$KV_NAME" --name "$SECRET" --query "name" -o tsv > /dev/null 2>&1; then
                    echo "  $SECRET: OK"
                  else
                    echo "  $SECRET: MISSING"
                    exit 1
                  fi
                done

                echo "All secrets verified!"
