# =============================================================================
# Pipeline: 03-secrets-setup.yml
# Purpose: One-time setup of application secrets in Azure Key Vault
# Triggers: Manual only
#
# Usage: Run this pipeline once per environment to populate Key Vault with
# Oluto-specific secrets. Terraform handles DB connection secrets;
# this pipeline handles application-specific secrets.
# =============================================================================

trigger: none

name: "Oluto Secrets Setup"

parameters:
  - name: environment
    displayName: "Target Environment"
    type: string
    default: "dev"
    values:
      - dev
      - prod

  - name: secretKey
    displayName: "Application Secret Key (JWT signing)"
    type: string

  - name: fuelixApiKey
    displayName: "Fuelix API Key"
    type: string

  - name: fuelixBaseUrl
    displayName: "Fuelix Base URL"
    type: string
    default: "https://api.fuelix.ai/v1"

  - name: fuelixModel
    displayName: "Fuelix Model"
    type: string
    default: "claude-haiku-4-5"

  - name: azureApiKey
    displayName: "Azure OCR API Key"
    type: string

  - name: azureOcrUrl
    displayName: "Azure OCR URL"
    type: string
    default: "https://profemzy-5149-resource.services.ai.azure.com/providers/mistral/azure/ocr"

  - name: azureOcrModel
    displayName: "Azure OCR Model"
    type: string
    default: "mistral-document-ai-2505"

variables:
  azureServiceConnection: "terraformiacdevops1"

stages:
  - stage: Setup_Secrets
    displayName: "Setup Secrets (${{ parameters.environment }})"
    jobs:
      - job: Populate_KeyVault
        displayName: "Populate Key Vault Secrets"
        pool:
          vmImage: "ubuntu-24.04"
        steps:
          - task: AzureCLI@2
            displayName: "Set Oluto Secrets in Key Vault"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Setting secrets in Key Vault: $KV_NAME"

                # Application secret
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-secret-key" \
                  --value "${{ parameters.secretKey }}" \
                  --output none

                # Celery / Redis (in-cluster Redis)
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-celery-broker-url" \
                  --value "redis://redis:6379/0" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-celery-result-backend" \
                  --value "redis://redis:6379/0" \
                  --output none

                # Fuelix AI
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-api-key" \
                  --value "${{ parameters.fuelixApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-base-url" \
                  --value "${{ parameters.fuelixBaseUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-fuelix-model" \
                  --value "${{ parameters.fuelixModel }}" \
                  --output none

                # Azure OCR
                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-api-key" \
                  --value "${{ parameters.azureApiKey }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-ocr-url" \
                  --value "${{ parameters.azureOcrUrl }}" \
                  --output none

                az keyvault secret set --vault-name "$KV_NAME" \
                  --name "oluto-azure-ocr-model" \
                  --value "${{ parameters.azureOcrModel }}" \
                  --output none

                echo "All Oluto secrets set successfully in $KV_NAME"

          - task: AzureCLI@2
            displayName: "Verify Secrets"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                KV_NAME="wackopscoach-${{ parameters.environment }}-kv"
                echo "Verifying secrets in $KV_NAME..."

                SECRETS=(
                  "oluto-secret-key"
                  "oluto-celery-broker-url"
                  "oluto-celery-result-backend"
                  "oluto-fuelix-api-key"
                  "oluto-fuelix-base-url"
                  "oluto-fuelix-model"
                  "oluto-azure-api-key"
                  "oluto-azure-ocr-url"
                  "oluto-azure-ocr-model"
                )

                for SECRET in "${SECRETS[@]}"; do
                  if az keyvault secret show --vault-name "$KV_NAME" --name "$SECRET" --query "name" -o tsv > /dev/null 2>&1; then
                    echo "  $SECRET: OK"
                  else
                    echo "  $SECRET: MISSING"
                    exit 1
                  fi
                done

                echo "All secrets verified!"
